#!/usr/bin/env bash

set -e

cli_help(){
    echo "
███████  ██████ ██████  ███████ ███████ ███    ██ ███████ ██   ██  ██████  ████████ 
██      ██      ██   ██ ██      ██      ████   ██ ██      ██   ██ ██    ██    ██    
███████ ██      ██████  █████   █████   ██ ██  ██ ███████ ███████ ██    ██    ██    
     ██ ██      ██   ██ ██      ██      ██  ██ ██      ██ ██   ██ ██    ██    ██    
███████  ██████ ██   ██ ███████ ███████ ██   ████ ███████ ██   ██  ██████     ██    
    

Custom screenshot and analysis script using aquatone

Usage: screenshot path/to/recon path/to/chromium"
exit 1
}

analyze(){
    echo "[ANALYZING] $1 ..."
    cat $1 | aquatone -debug -ports=80,443 -resolution=800,600 -chrome-path=$2 -out $3
}

if [ -z $1 ]; then
    cli_help
fi

TARGETS_DIR=$1
CHROME_PATH=$2

if [ ! -d "$TARGETS_DIR" ]; then
    echo "Directory '$TARGETS_DIR' does not exist"
    cli_help
fi

if [ ! $CHROME_PATH ]; then
    echo "Chrome binary is required"
    cli_help
fi

if [ ! -f $CHROME_PATH ]; then
    echo "Chrome binary does not exist"
    cli_help
fi

echo "------------------------------"
echo "[TARGETS DIRECTORY] $TARGETS_DIR"
echo "[CHROME BINARY] $CHROME_PATH"
echo "[TARGETS FOUND]"
echo "$(ls $TARGETS_DIR)"
echo "------------------------------"

cd $TARGETS_DIR

# Loop over targets
for target in *; do 
    [ -d $target ] || continue

    # Check for http probes list
    probes_file="$target/httpx.txt"
    if [ ! -f $probes_file ]; then
        echo "$probes_file not found, skipping..."
        echo "------------------------------"
        continue
    fi

    # Run analysis
    results_dir="$target/screenshots"
    if [ ! -d $results_dir ]; then
        mkdir $results_dir
    fi
    analyze $probes_file $CHROME_PATH $results_dir
    echo "------------------------------"
done

echo ""
echo "[DONE]"
