#!/usr/bin/env bash

set -e

cli_help(){
    echo "
███████ ███    ██ ██    ██ ███    ███ 
██      ████   ██ ██    ██ ████  ████ 
█████   ██ ██  ██ ██    ██ ██ ████ ██ 
██      ██  ██ ██ ██    ██ ██  ██  ██ 
███████ ██   ████  ██████  ██      ██ 

    
Custom subdomain enumeration script using amass

Usage: enum path/to/recon [path/to/amass_config.ini]"
exit 1
}

enum_domains(){
    cmd="amass enum -df $1"
    if [ $2 ]; then
        cmd="$cmd -config $2"
    fi
    cmd="$cmd || true"
    echo "[RUNNING] $cmd"
    $cmd
}

write_enum_results(){
    cmd="amass db -names -d $1 | sort | uniq > $2"
    echo "[RUNNING] $cmd"
    $cmd
}

if [ -z $1 ]; then
    cli_help
fi

RECON_DIR=$1
AMASS_CONFIG=$2

if [ ! -d "$RECON_DIR" ]; then
    echo "Directory '$RECON_DIR' does not exist"
    cli_help
fi

if [ $AMASS_CONFIG ] && [ ! -f $AMASS_CONFIG ]; then
    echo "Configuration file '$AMASS_CONFIG' does not exist"
    cli_help
fi

echo "------------------------------"
echo "[RECON DIRECTORY] $RECON_DIR"
echo "[AMASS CONFIG FILE] $( if [ $AMASS_CONFIG ]; then echo $AMASS_CONFIG; else echo "N/A"; fi )"
echo "[TARGETS FOUND]"
echo "$(ls $RECON_DIR)"
echo "------------------------------"

cd $RECON_DIR

results_filename="$(date +"%Y%m%d").txt"

# Loop over targets
for target in *; do 
    [ -d $target ] || continue
    echo "[DOMAINS OF TARGET] $target"

    # Check for domains list
    domains_list="$target/domains.txt"
    if [ ! -f $domains_list ]; then
        echo "$domains_list not found, skipping..."
        echo "------------------------------"
        continue
    fi
    enum_domains $domains_list $AMASS_CONFIG

    # Write enum results
    subdomains_dir="$target/subdomains"
    if [ ! -d $subdomains_dir ]; then
        mkdir $subdomains_dir
    fi
    write_enum_results $domains_list "$subdomains_dir/$results_filename"

    echo "------------------------------"
done

echo ""
echo "[DONE]"
